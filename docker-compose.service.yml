services:
  # =============================================
  # Layer 1: Discovery Server (starts first)
  # Depends on: postgres, kafka, redis (from docker-compose.yml)
  # =============================================
  discovery-server:
    image: tawn/discovery-server:latest
    container_name: tamsang-discovery-server
    ports:
      - "8761:8761"
    depends_on:
      postgres-tamsang:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8761/actuator/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # =============================================
  # Layer 2: Config Server
  # Depends on: discovery-server
  # =============================================
  config-server:
    image: tawn/config-server:latest
    container_name: tamsang-config-server
    ports:
      - "8888:8888"
    depends_on:
      discovery-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8888/actuator/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # =============================================
  # Layer 3: API Gateway
  # Depends on: discovery-server, config-server
  # =============================================
  api-gateway:
    image: tawn/api-gateway:latest
    container_name: tamsang-api-gateway
    ports:
      - "8080:8080"
    depends_on:
      config-server:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # =============================================
  # Layer 4: Business Services
  # Depends on: api-gateway (which implies config + discovery)
  # =============================================
  identity-service:
    image: tawn/identity-service:latest
    container_name: tamsang-identity-service
    ports:
      - "8082:8080"
    depends_on:
      api-gateway:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    restart: unless-stopped

  core-service:
    image: tawn/core-service:latest
    container_name: tamsang-core-service
    ports:
      - "8084:8080"
    depends_on:
      api-gateway:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    restart: unless-stopped

  file-service:
    image: tawn/file-service:latest
    container_name: tamsang-file-service
    ports:
      - "8083:8083"
    depends_on:
      api-gateway:
        condition: service_healthy
      minio:
        condition: service_healthy
    env_file:
      - ./file-service/.env
    restart: unless-stopped

  blockchain-service:
    image: tawn/blockchain-service:latest
    container_name: tamsang-blockchain-service
    ports:
      - "8085:8085"
    depends_on:
      api-gateway:
        condition: service_healthy
      kafka:
        condition: service_healthy
    env_file:
      - ./blockchain-service/.env
    restart: unless-stopped

  ai-service:
    image: tawn/ai-service:latest
    container_name: tamsang-ai-service
    ports:
      - "8000:8000"
    depends_on:
      api-gateway:
        condition: service_healthy
      kafka:
        condition: service_healthy
    env_file:
      - ./ai-service/.env
    restart: unless-stopped
